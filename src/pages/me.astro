---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mon compte">
  <main class="me-page">
    <nav class="top-nav">
      <a href="/" class="back-btn">← Retour aux recettes</a>
    </nav>
    <section class="me-card">
      <h1>Mon compte</h1>
      <p class="hint">Ces informations sont récupérées depuis l'API.</p>

      <div id="me-content" class="me-content" aria-live="polite">
        <p>Chargement…</p>
      </div>
    </section>
  </main>
</Layout>

<style>
  .me-page{ max-width: 1100px; margin: 0 auto; padding: 2rem 1rem }
  .top-nav{ display:flex; justify-content:flex-start; margin-bottom: 1rem }
  .back-btn{ display:inline-flex; align-items:center; gap:.5rem; padding: .6rem 1rem; border-radius:12px; color:#fff; text-decoration:none; background: linear-gradient(135deg, #ff7a59, #ff3d81); box-shadow: 0 6px 16px rgba(255,61,129,.3); transition: transform .2s ease, box-shadow .2s ease; font-weight:600 }
  .back-btn:hover{ transform: translateY(-2px); box-shadow: 0 10px 24px rgba(255,61,129,.4) }
  .me-card{ background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); border:1px solid #f1f5f9; padding:1.5rem }
  .me-card h1{ margin:0 0 .25rem 0 }
  .hint{ color:#6b7280; margin:0 0 1rem 0 }
  .me-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:1rem }
  .me-item{ background:#f9fafb; border-radius:12px; padding:1rem; border-left:4px solid transparent; background-image: linear-gradient(#f9fafb, #f9fafb), linear-gradient(135deg,#ff7a59,#ff3d81); background-origin: padding-box, border-box; background-clip: padding-box, border-box }
  .me-item h3{ margin:0 0 .25rem 0; font-size: .95rem; color:#6b7280 }
  .me-item p{ margin:0; font-weight:600; color:#111827 }
</style>

<script type="module">
  const API_BASE = 'https://gourmet.cours.quimerch.com';
  const content = document.getElementById('me-content');

  function getToken(){
    const match = document.cookie.match(/(?:^|; )authToken=([^;]*)/);
    return match ? decodeURIComponent(match[1]) : '';
  }

  async function loadMe(){
    const token = getToken();
    if(!token){ content.innerHTML = '<p>Vous n\'êtes pas connecté.</p>'; return }
    try{
      const res = await fetch(`${API_BASE}/me`,{ headers:{ 'Accept':'application/json, application/xml', Authorization:`Bearer ${token}` } });
      if(!res.ok){ content.innerHTML = '<p>Impossible de récupérer votre profil.</p>'; return }
      const data = await res.json();
      const created = data.created_at ? new Date(data.created_at).toLocaleString() : '—';
      content.innerHTML = `
        <div class="me-grid">
          <div class="me-item"><h3>Nom complet</h3><p>${escapeHtml(data.full_name||'—')}</p></div>
          <div class="me-item"><h3>Nom d'utilisateur</h3><p>${escapeHtml(data.username||'—')}</p></div>
          <div class="me-item"><h3>Email</h3><p>${escapeHtml(data.email||'—')}</p></div>
          <div class="me-item"><h3>Créé le</h3><p>${escapeHtml(created)}</p></div>
        </div>
      `;
    }catch(err){ content.innerHTML = '<p>Erreur lors du chargement.</p>' }
  }

  function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[c]) }

  loadMe();
</script>
