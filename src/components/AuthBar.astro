---
const API_BASE = 'https://gourmet.cours.quimerch.com';
---

<header class="auth-header">
  <div class="brand"><a href="/" title="Accueil">XiJinPain</a></div>
  <div class="auth-controls">
    <a id="account-link" href="/me" class="account-link" style="display:none" title="Détails du compte">Mon compte</a>
    <a id="favorites-link" href="/favorites" class="fav-link" aria-label="Mes favoris" style="display:none" title="Consulter les favoris">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="currentColor"/>
      </svg>
    </a>
    <button id="login-btn" class="auth-btn gradient" aria-haspopup="dialog" title="Se connecter">Se connecter</button>
    <button id="logout-btn" class="auth-btn outline" style="display:none" title="Se déconnecter">Se déconnecter</button>
  </div>
</header>

<div id="login-success" class="toast" style="display:none" role="status" aria-live="polite">
  <div class="toast-icon" aria-hidden="true">
    <svg viewBox="0 0 24 24" focusable="false">
      <path d="M9.5 16.2 5.8 12.5l-1.3 1.3 5 5 10-10-1.3-1.3z" fill="currentColor" />
    </svg>
  </div>
  <div class="toast-content">
    <strong>Connexion réussie</strong>
    <span>Bon retour parmi nous.</span>
  </div>
</div>

<!-- Modal de login -->
<div id="login-modal" class="login-modal" role="dialog" aria-modal="true" aria-labelledby="login-title" style="display:none">
  <div class="login-card">
    <h3 id="login-title">Connexion</h3>
    <form id="login-form">
      <label>
        Identifiant
        <input type="text" id="login-identifier" required placeholder="votre identifiant" />
      </label>
      <label>
        Mot de passe
        <input type="password" id="login-password" required placeholder="••••••••" />
      </label>
      <div class="actions">
        <button type="submit" class="auth-btn gradient">Se connecter</button>
        <button type="button" id="close-modal" class="auth-btn">Annuler</button>
      </div>
      <p id="login-error" class="error" aria-live="assertive" style="display:none"></p>
    </form>
  </div>
</div>

<style>
  .auth-header{ display:flex; justify-content:space-between; align-items:center; padding: .75rem 1rem; background:#fff; border-bottom:1px solid #f1f5f9; position:sticky; top:0; z-index:50 }
  .brand a{ text-decoration:none; color:#111827; font-weight:700; letter-spacing:.3px }
  .auth-controls{ display:flex; align-items:center; gap:.5rem }
  .account-link{ text-decoration:none; color:#111827; font-weight:600; padding:.4rem .7rem; border-radius:10px; border:1px solid #e5e7eb; background:#fff }
  .account-link:hover{ box-shadow:0 4px 12px rgba(0,0,0,.08); transform: translateY(-1px) }
  .fav-link{ display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:50%; background:#fff; border:1px solid #e5e7eb; color:#ff3d81; transition: all .2s ease }
  .fav-link svg{ width:20px; height:20px }
  .fav-link:hover{ box-shadow:0 4px 12px rgba(0,0,0,.1); transform: translateY(-1px) }
  /* auth-status removed */
  .auth-btn{ padding:.5rem .9rem; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:600 }
  .auth-btn.gradient{ background: linear-gradient(135deg,#ff7a59,#ff3d81); color:#fff; border:none; box-shadow:0 6px 16px rgba(255,61,129,.25) }
  .auth-btn.gradient:hover{ transform: translateY(-2px); box-shadow:0 10px 24px rgba(255,61,129,.35) }
  .auth-btn.outline{ border:2px solid #ff7a59; color:#ff3d81; background:#fff }

  .login-modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:1rem; z-index:9999 }
  .login-card{ width:100%; max-width:560px; background:#fff; border-radius:16px; box-shadow:0 24px 72px rgba(0,0,0,.35); padding:1.25rem; position:relative; z-index:10000 }
  .login-card h3{ margin:0 0 .75rem 0 }
  .login-card form{ display:flex; flex-direction:column; gap:.75rem }
  .login-card input{ width:100%; padding:.7rem .85rem; border-radius:10px; border:1px solid #e5e7eb; box-sizing:border-box }
  .login-card .actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem }
  .error{ color:#ef4444; font-size:.9rem }

  .toast{ position:fixed; top:90px; right:16px; display:flex; gap:.75rem; align-items:center; background:#fff; border:1px solid #e5e7eb; box-shadow:0 18px 48px rgba(0,0,0,.15); border-radius:14px; padding:.8rem 1rem; z-index:12000; opacity:0; transform: translateY(-8px) scale(.98); pointer-events:none; transition: opacity .2s ease, transform .2s ease }
  .toast.show{ opacity:1; transform: translateY(0) scale(1); pointer-events:auto; animation: toast-pop .25s ease }
  .toast-icon{ width:32px; height:32px; border-radius:50%; background: linear-gradient(135deg,#34d399,#10b981); display:flex; align-items:center; justify-content:center; color:#fff; flex-shrink:0 }
  .toast-icon svg{ width:18px; height:18px }
  .toast-content{ display:flex; flex-direction:column; gap:2px; color:#0f172a }
  .toast-content strong{ font-size:.95rem; line-height:1.2 }
  .toast-content span{ font-size:.85rem; color:#4b5563 }
  @keyframes toast-pop{ 0%{ opacity:0; transform: translateY(-10px) scale(.96) } 100%{ opacity:1; transform: translateY(0) scale(1) } }

  /* Responsive */
  @media (max-width: 768px) {
    .auth-header{ padding: .5rem .75rem; flex-wrap: wrap; gap: .5rem }
    .brand a{ font-size: .95rem }
    .auth-controls{ gap: .35rem; flex-wrap: wrap }
    .account-link{ padding: .35rem .5rem; font-size: .85rem }
    .auth-btn{ padding: .4rem .65rem; font-size: .85rem }
    .fav-link{ width: 36px; height: 36px }
    .fav-link svg{ width: 18px; height: 18px }
    .login-card{ padding: 1rem; max-width: 95% }
    .toast{ right: 8px; top: 70px; padding: .6rem .8rem }
    .toast-icon{ width: 28px; height: 28px }
    .toast-content strong{ font-size: .85rem }
    .toast-content span{ font-size: .75rem }
  }

  @media (max-width: 480px) {
    .auth-header{ padding: .4rem .5rem }
    .brand a{ font-size: .9rem }
    .account-link{ font-size: .8rem; padding: .3rem .45rem }
    .auth-btn{ padding: .35rem .55rem; font-size: .8rem }
    .fav-link{ width: 32px; height: 32px }
    .fav-link svg{ width: 16px; height: 16px }
    .login-card h3{ font-size: 1.1rem }
    .login-card input{ padding: .6rem .7rem; font-size: .9rem }
  }
</style>

<script type="module">
  const API_BASE = 'https://gourmet.cours.quimerch.com';

  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const loginModal = document.getElementById('login-modal');
  const closeModal = document.getElementById('close-modal');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  // auth-status removed
  const accountLink = document.getElementById('account-link');
  const favoritesLink = document.getElementById('favorites-link');
  const loginSuccess = document.getElementById('login-success');
  let toastTimeout;

  function getToken(){
    const match = document.cookie.match(/(?:^|; )authToken=([^;]*)/);
    return match ? decodeURIComponent(match[1]) : '';
  }
  function setToken(t){
    const isSecure = location.protocol === 'https:';
    const attrs = ['path=/', 'SameSite=Lax', 'Max-Age=604800']; // 7 days
    if(isSecure) attrs.push('Secure');
    document.cookie = `authToken=${encodeURIComponent(t)}; ${attrs.join('; ')}`;
  }
  function clearToken(){
    const isSecure = location.protocol === 'https:';
    const attrs = ['path=/', 'SameSite=Lax', 'Max-Age=0'];
    if(isSecure) attrs.push('Secure');
    document.cookie = `authToken=; ${attrs.join('; ')}`;
  }

  function setLoggedInUI(){
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-flex';
    accountLink.style.display = 'inline-flex';
    favoritesLink.style.display = 'inline-flex';
  }
  function setLoggedOutUI(){
    loginBtn.style.display = 'inline-flex';
    logoutBtn.style.display = 'none';
    accountLink.style.display = 'none';
    favoritesLink.style.display = 'none';
    accountLink.textContent = 'Mon compte';
  }

  function showSuccessToast(){
    if(!loginSuccess) return;
    loginSuccess.style.display = 'flex';
    loginSuccess.classList.add('show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(()=>{
      loginSuccess.classList.remove('show');
      setTimeout(()=>{ loginSuccess.style.display='none'; }, 250);
    }, 2800);
  }

  async function fetchMe(){
    const token = getToken();
    if(!token) return false;
    try{
      const res = await fetch(`${API_BASE}/me`,{
        headers:{ 'Accept':'application/json, application/xml', Authorization:`Bearer ${token}` }
      });
      if(res.ok){
        const data = await res.json();
        const displayName = data.full_name || data.username || data.email || 'Mon compte';
        accountLink.textContent = displayName;
        accountLink.style.display = 'inline-flex';
        return true;
      } else if(res.status === 401 || res.status === 403){
        // Token expired or invalid
        clearToken();
        setLoggedOutUI();
        return false;
      }
    }catch(err){ /* ignore */ }
    return false;
  }

  // Init UI with token validation
  const initToken = getToken();
  if(initToken){ 
    setLoggedInUI();
    const isValid = await fetchMe();
    if(!isValid){ setLoggedOutUI(); }
  } else { 
    setLoggedOutUI(); 
  }

  loginBtn.addEventListener('click', ()=>{ loginModal.style.display='flex' })
  closeModal.addEventListener('click', ()=>{ loginModal.style.display='none'; loginError.style.display='none'; loginError.textContent='' })

  loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    loginError.style.display='none'; loginError.textContent='';
    const identifier = document.getElementById('login-identifier').value.trim();
    const password = document.getElementById('login-password').value.trim();

    try{
      const res = await fetch(`${API_BASE}/login`,{
        method:'POST',
        headers:{
          'Accept':'application/json, application/xml',
          'Content-Type':'application/json'
        },
        body: JSON.stringify({ username: identifier, password })
      });

      if(res.ok){
        const data = await res.json();
        const token = data.token || '';
        if(token){
          setToken(token);
          setLoggedInUI();
          await fetchMe();
          showSuccessToast();
          loginModal.style.display='none';
          // Rafraîchir la page pour mettre à jour l'état des favoris
          setTimeout(() => location.reload(), 500);
          return;
        }
      }
    }catch(err){ /* network error */ }
    
    loginError.textContent = 'Échec de connexion. Vérifiez vos identifiants.';
    loginError.style.display = 'block';
  });

  logoutBtn.addEventListener('click', async ()=>{
    const token = getToken();
    try{
      await fetch(`${API_BASE}/logout`,{ method:'GET', headers:{ Authorization: token?`Bearer ${token}`:'', Accept:'application/json, application/xml' } });
    }catch(err){ /* ignore */ }
    clearToken(); setLoggedOutUI();
    // Rafraîchir la page pour réinitialiser l'état
    setTimeout(() => location.reload(), 300);
  })
</script>
